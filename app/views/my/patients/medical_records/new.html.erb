<div class="tabbar">
  <div class="weui-tab">
      <div class="weui-tab__panel">

          <div class="panel">
            <div class="bd">
              <div class="weui-cells__title">表单</div>
              <div class="weui-cells weui-cells_form">
                <%= render 'new_form', url: my_patients_medical_records_path, method: 'POST' %>
              </div>
            </div>

            </div>
          </div>

      </div>

      <div class="weui-tabbar">
        <a href="/my/patients/reservations" class="weui-tabbar__item">
          <img src="/icon_nav_button.png" alt="" class="weui-tabbar__icon">
          <p class="weui-tabbar__label">当前预约</p>
        </a>

        <a href="/posts" class="weui-tabbar__item">
          <img src="/icon_nav_article.png" alt="" class="weui-tabbar__icon">
          <p class="weui-tabbar__label">必读文章</p>
        </a>
        <a href="/my/patients/index" class="weui-tabbar__item weui_bar__item_on">
          <img src="/icon_nav_cell.png" alt="" class="weui-tabbar__icon">
          <p class="weui-tabbar__label">我</p>
        </a>
      </div>

  </div>
</div>


<%- content_for :js  do %>
  <%= javascript_include_tag :uploader %>
  <script type="text/javascript">
    $(document).on("ready", function(){

      console.log(isWeiXin())
      console.log(isAndroid())


      if( true ){

        uploader1 = new uploader( 'picker1', '.weui_uploader1', '/global_images.js', 'multiple', 'medical_record_images', true)
        uploader2 = new uploader( 'picker2', '.weui_uploader2', '/global_images.js', 'multiple', 'laboratory_examination_images', true)
        uploader3 = new uploader( 'picker3', '.weui_uploader3', '/global_images.js', 'multiple', 'imaging_examination_images', true)

        alert('disable browse, let wx chooseImage to trigger image picker')

        uploader1.bind('browse', function(up, files){
          console.log('Browse xxxx ')
        })

        wx.config({
          debug: false,
          appId: "<%= @appId %>",
          timestamp: "<%= @timestamp %>",
          nonceStr: "<%= @nonceStr %>",
          signature: "<%= @signature %>",
          jsApiList: ['checkJsApi', 'chooseWXPay', 'chooseImage', 'uploadImage', 'downloadImage'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });

        wx.ready(function(){
          alert('config is ready, checking js api available');
          wx.checkJsApi({
             jsApiList: [
               'chooseWXPay',
               'previewImage',
               'chooseImage',
               'uploadImage',
               'downloadImage'
             ],
             success: function (res) {
               alert(JSON.stringify(res));
             }
           });

        });

        wx.error(function(){
          alert('config is error');
        })

        var images = {
          localId: [],
          serverId: []
        };


        $(document).on('click', '#picker1, #picker2, #picker3', function(e){

          uploader1.disableBrowse()
          uploader2.disableBrowse()
          uploader3.disableBrowse()

          console.log('chooseImage')

          console.log(e.target)
          console.log($(e.target))

          wx.chooseImage({
              count:      9, // 默认9
              sizeType:   ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
              sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
              success: function (res) {
                  images.localId = res.localIds;

                  var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                  for (var i = 0; i<localIds.length; i++) {
                    $files = $(e.target).parents('.weui-uploader').find('.weui-uploader__files')
                    $files.find('.weui-uploader__file.holder').remove()
                    // $files = $('.weui_uploader2').find('.weui-uploader__files')
                    // $files.find('.weui-uploader__file.holder').remove()
                    $li = $('<li class="weui-uploader__file">').css("background-image", "url(" + localIds[i] + ")")
                    // $input = $('<input type="hidden">').attr("name", "reservation[photos][" + i + "]").attr('value', localIds[i])

                    wx.uploadImage({
                        localId: localIds[i],
                        success: function(res) {
                          images.serverId.push(res.serverId);
                          $input = $('<input type="hidden">').attr("name", "reservation[photos][" + i + "]").attr('value', res.serverId)
                        },
                        fail: function(res) {
                          alert(JSON.stringify(res));
                        }
                    });

                    $li.append($input)
                    $files.append($li)

                    // var img = new mOxie.Image();
                    // img.load(localIds[i])

                    // if($(e.target).attr('id')== '#picker1'){
                    //   alert('add file to uploader1')
                    //   uploader1.addFile(img)
                    // }else if($(e.target).attr('id') == '#picker2'){
                    //   alert('add file to uploader2')
                    //   uploader2.addFile(img)
                    // }else{
                    //   alert('add file to uploader3')
                    //   uploader3.addFile(img)
                    // }

                    console.log(localIds[i])

                  }
              }
          });
        })







      }else{

        uploader1 = new uploader( 'picker1', '.weui_uploader1', '/global_images.js', 'multiple', 'medical_record_images')
        uploader2 = new uploader( 'picker2', '.weui_uploader2', '/global_images.js', 'multiple', 'laboratory_examination_images')
        uploader3 = new uploader( 'picker3', '.weui_uploader3', '/global_images.js', 'multiple', 'imaging_examination_images')


      }
    })
  </script>
<% end %>
