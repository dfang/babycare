import $ from 'jquery'
import wx from 'wechat-jssdk-promise';
import jssdk from "./config_js_sdk";

$(function() {
  jssdk.config(window.location);

  wx.ready(() => {
    console.log("wx is ready");
    <% if @order_params.present? %>
        var orderParams = {
          appId:     "<%= @order_params[:appId] %>",
          timeStamp: "<%= @order_params[:timeStamp] %>",
          nonceStr:  "<%= @order_params[:nonceStr] %>",
          package:   "<%= @order_params[:package] %>",
          paySign:   "<%= @order_params[:paySign] %>",
          signType:  "<%= @order_params[:signType] %>"
        };

    $(document).on('click', '#wechatPaymentBtn', function(e){
      console.log('choose WxPay')
      wx.chooseWXPay({
                timestamp: orderParams.timeStamp,
                nonceStr:  orderParams.nonceStr,
                package:   orderParams.package,
                signType:  orderParams.signType,
                paySign:   orderParams.paySign,
                success: function (res) {
                  if(res["errMsg"] == "chooseWXPay:ok"){
                    // check payments and change aasm_state in payment_notify_url(set when generate_payment_options)
                    // and redirect to reservation status page
                    location.href = "<%= patients_reservation_path(@reservation) %>"
                  }
                },
                fail: function(res){
                  console.log(JSON.stringify(res));
                  alert('支付请求失败, 请联系我们');
                }
            });
    })

    <% end %>
  });


  wx.error(function(res){
    alert("初始化微信js sdk出错，可能无法完成支付，请联系我们");
  })
})
