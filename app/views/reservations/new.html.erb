<div class="tabbar">
  <div class="weui-tab">

    <div class="weui-tab__panel">
      <div class="panel">
        <div class="page__hd">
          <h1 class="page__title">我要预约</h1>
          <p class="page__desc">目前
            我们只针对儿童开放预约。。。。。</p>
        </div>

        <div class="page__bd">

          <%- default_date = Time.zone.tomorrow.at_beginning_of_day.advance(hours: 10).strftime("%Y-%m-%dT%H:%M") %>

          <%= simple_form_for Reservation.new, url: reservations_path, method: 'POST' do |f| %>

          <!-- <div class="weui-cells__title">预约</div> -->

          <!-- <p class="weui-cells__tips">准备预约医生提交预约医生完善姓名、小孩性别、您的联系方式、您的位置、不适症状描述</p> -->

          <div class="weui-cells weui-cells_form">

            <%= f.hidden_field :reservation_type, value: params[:type] %>
            <%= f.hidden_field :user_a, value: current_user.id %>

            <div class="weui-cell weui-cell_select weui-cell_select-after">
              <div class="weui-cell__hd">
                <label class="weui-label">为谁预约</label>
              </div>
              <div class="weui-cell__bd weui-cell_primary">
                <select class="weui-select" name="reservation[user_c]" data-parsley-required="true">
                  <%= options_for_select  current_user.children.map {|x| [x.name, x.id] }, params[:user_c] %>
                </select>
              </div>
            </div>

            <div class="weui-cell">
              <div class="weui-cell__hd">
                <label class="weui-label">想预约在</label>
              </div>
              <div class="weui-cell__bd weui-cell_primary">
                <input class="weui-input" name="reservation[reservation_date]" placeholder="请选择一个大概的时间" type="datetime-local" value="<%= default_date %>" data-parsley-required="true">
              </div>
            </div>

            <div class="weui-cell">
              <div class="weui-cell__hd">
                <label class="weui-label">有什么症状</label>
              </div>
            </div>

            <div class="weui-cell">
              <div id="symptom-tags"></div>
            </div>

            <div class="weui-cell hide">
              <div id="symptom-tag-details"></div>
            </div>

            <div class="weui-cell weui-cell-remark">
              <div class="weui-cell__bd weui-cell_primary">
                <textarea class="weui-textarea" name="reservation[chief_complains]" data-parsley-required="true" placeholder="请大概描述下你孩子的情况"></textarea>
              </div>
            </div>

            <div class="weui-cell weui-cell-vcode">
              <div class="weui-cell__hd">
                <label class="weui-label">您的位置</label>
              </div>
              <div class="weui-cell__bd">
                <textarea class="weui-textarea" name="reservation[location]" data-parsley-required="true" placeholder="获取你的位置以便最近的医生联系你">
                  <%= current_user.location %>
                </textarea>
              </div>
              <div class="weui-cell__ft">
                <a href="javascript:void(0)" class="weui-vcode-btn">定位</a>
              </div>
            </div>

            <div class="weui-cell">
              <div class="weui-cell__hd">
                <label class="weui-label">怎么称呼您</label>
              </div>
              <div class="weui-cell__bd weui-cell_primary">
                <input class="weui-input" name="reservation[name]" data-parsley-required="true" placeholder="尊姓大名" type="text" value="<%= current_user.name %>">
              </div>
            </div>

            <div class="weui-cell">
              <div class="weui-cell__hd">
                <label class="weui-label">您的联系方式</label>
              </div>
              <div class="weui-cell__bd weui-cell_primary">
                <input
                  class="weui-input"
                  name="reservation[reservation_phone]"
                  placeholder="医生可以看到您的电话并联系你"
                  type="number"
                  data-parsley-required="true"
                  data-parsley-pattern="/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/"
                  data-parsley-type="integer"
                  data-parsley-length="[11,11]"
                  value="<%= current_user.mobile_phone %>">
              </div>
            </div>
          </div>

          <div class="weui-btn-area">
            <%= f.button :submit, "确定", class: "weui-btn weui-btn__primary", data: { disable_with: '正在提交...' } %>
          </div>

          <% end %>

        </div>
      </div>
    </div>

    <%=  render 'patients/tab_bar' %>

  </div>
</div>



<!-- <%= content_for :css do %>
<%= stylesheet_link_tag :bootstrap_fontawesome %>
<% end %> -->

<%- content_for :js  do %>
<script type="text/javascript">
  $(function () {

    symptom_tag_details = <%= raw @symptom_details %>

    url = location.href.split('#')[0]
    console.log('url is .....', url)

    $.ajax({
      url: "/wx/config_jssdk.json?url=" + escape(url)
    }).done(function (data) {

      console.log('fuck ');
      console.log("data is ");
      console.log(data)

      var config = {
        debug:      false,
        appId:      data.appId,
        timestamp:  data.timestamp,
        nonceStr:   data.nonceStr,
        signature:  data.signature,
        jsApiList:  data.jsApiList
      }

      console.log("config is " );
      console.log(config);

      wx.config(config);
      wx.error(function (res) {
        alert("初始化微信js sdk出错，请联系我们");
      })
    })

    wx.ready(function () {
      $(document).on('click', '.weui-vcode-btn', function (e) {
        console.log('click get Location');
        wx.getLocation({
          type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
          success: function (res) {
            var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
            var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
            var speed = res.speed; // 速度，以米/每秒计
            var accuracy = res.accuracy; // 位置精度

            var data = {
              location: latitude + "," + longitude,
              key: "GHPBZ-BCE3X-GPT4A-7EJHJ-G2TPQ-PTFBQ",
              get_poi: 0,
              output: "jsonp"
            }
            var url = "http://apis.map.qq.com/ws/geocoder/v1/?";
            console.log('convert latitude and longitude to address');
            $.ajax({
              type: "get",
              dataType: 'jsonp',
              data: data,
              jsonp: "callback",
              jsonpCallback: "QQmap",
              url: url,
              success: function (json) {
                // var toStr = JSON.stringify(json);
                console.log(json.result.address)
                if (json.status == 0) {
                  $('textarea[name="reservation[location]"]').val(json.result.address)
                }
              },
              error: function (err) {
                alert("服务端错误，请刷新浏览器后重试")
              }
            })
          },
          cancel: function (res) {
            alert('你拒绝了授权获取地理位置');
          }
        });
      })
    });

    $('#symptom-tags').tags({
      values: <%= raw @symptoms %>,
      templates: {
        pill: '<span class="badge badge-info tag-badge" data-tag-id="{1}" style="overflow: hidden; white-space: nowrap;" class="tag-remove">{0}</span>',
        number: '<sup><small>{0}</small></sup>'
      },
      input_name: "tag_list[]",
      can_delete: false,
      can_add: false
    });

    $(document).on('click', '#symptom-tags .pills-list .badge', function (e) {
      $(e.target).siblings().removeClass('active').end().toggleClass('active')
      tag = $(e.target).text()
      details = []
      for (var i = 0, len = symptom_tag_details.length; i < len; i++) {
        if (symptom_tag_details[i].name == tag) {
          details = symptom_tag_details[i].values
        }
      }
      $('#symptom-tag-details').parents('.weui-cell').removeClass('hide')
      $('#symptom-tag-details').empty()
      $('#symptom-tag-details').tags({
        values: details,
        templates: {
          pill: '<span class="badge badge-info tag-badge" data-tag-id="{1}" style="overflow: hidden; white-space: nowrap;" class="tag-remove">{0}</span>',
          number: '<sup><small>{0}</small></sup>'
        },
        input_name: "tag_list[]",
        can_delete: false,
        can_add: false
      });
    })

    $(document).on('click', '#symptom-tag-details .pills-list .badge', function (e) {
      $(e.target).toggleClass('active')
      details = []
      $(e.target).parent('.pills-list').find('.badge.active').map(function (i, e) {
        details.push($(e).text())
      })

      text = "病请描述：大夫您好, 我的宝宝, "

      console.log(text + details)
      $('.weui-cell-remark .weui-textarea').val(text + details)

    })

    $('.simple_form.new_reservation').parsley({uiEnabled: true, errorsWrapper: ''}).on('field:error', function () {
      $(this.$element).parents('.weui-cell').addClass('validation_error')
    }).on('field:success', function () {
      $(this.$element).parents('.weui-cell').removeClass('validation_error')
    })
  })
</script>
<% end %>
