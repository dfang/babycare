<% if @reservation.to_prepay? %>
  <%= render 'to_prepay' %>
<% else %>
  <%= render 'to_pay' %>
<% end %>

<%= content_for :js do %>
  <%= javascript_tag do %>
    $(function(){
      <% if @order_params.present? %>
        var orderParams = {
          appId:     "<%= @order_params[:appId] %>",
          timeStamp: "<%= @order_params[:timeStamp] %>",
          nonceStr:  "<%= @order_params[:nonceStr] %>",
          package:   "<%= @order_params[:package] %>",
          paySign:   "<%= @order_params[:paySign] %>",
          signType:  "<%= @order_params[:signType] %>"
        };

        url = location.href.split('#')[0]
        $.ajax({
          url:   "/wx/config_jssdk.json?url=" + escape(url),
        })
        .done(function(data){

          wx.config({
            debug:     false,
            appId:     data.appId,
            timestamp: data.timestamp,
            nonceStr:  data.nonceStr,
            signature: data.signature,
            jsApiList: data.jsApiList
          });

          wx.error(function(res){
            alert("初始化微信js sdk出错，请联系我们");
          })

          wx.ready(function(){
            console.log('fuck')
            console.log('wx ready, click to pay')

            $('#wechatPaymentBtn').on('click', function() {

              wx.chooseWXPay({
                  timestamp: orderParams.timeStamp,
                  nonceStr:  orderParams.nonceStr,
                  package:   orderParams.package,
                  signType:  orderParams.signType,
                  paySign:   orderParams.paySign,
                  success: function (res) {
      							if(res["errMsg"] == "chooseWXPay:ok"){
      								// check payments and change aasm_state in payment_notify_url(set when generate_payment_options)
                      // and redirect to reservation status page
                      location.href = "<%= patients_reservation_path(@reservation) %>"
      							}
                  },
      						fail: function(res){
      							console.log(JSON.stringify(res));
                    alert('支付请求失败, 请联系我们');
      						}
              });
            });
          })
      })
      <% end %>
    })
  <% end %>
<% end %>
