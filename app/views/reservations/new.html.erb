<%= simple_form_for resource, url: reservations_path, method: 'POST' do |f| %>


  <div class="weui-cells__title">预约</div>

  <!-- <p class="weui-cells__tips">准备预约医生提交预约医生完善姓名、小孩性别、您的联系方式、您的位置、不适症状描述</p> -->

  <div class="weui-cells weui-cells_form">

    <div class="weui-cell">
      <div class="weui-cell__hd">
        <label class="weui-label" for="">怎么称呼您</label>
      </div>
      <div class="weui-cell__bd weui-cell_primary">
        <input class="weui-input" name="reservation[name]" data-parsley-required="true" placeholder="这里写王先生或郑女士就可以了" type="text" value="">
      </div>
    </div>

    <div class="weui-cell weui-cell_select weui-cell_select-after">
      <div class="weui-cell__hd">
          <label for="" class="weui-label">男孩还是女孩</label>
      </div>
      <div class="weui-cell__bd weui-cell_primary">
          <select class="weui-select" name="reservation[child_gender]" data-parsley-required="true">
            <%= options_for_select Reservation::GENDERS, "儿子" %>
          </select>
      </div>
    </div>

    <div class="weui-cell">
      <div class="weui-cell__hd">
        <label class="weui-label" for="">您的电话</label>
      </div>
      <div class="weui-cell__bd weui-cell_primary">
        <input class="weui-input" name="reservation[reservation_phone]" placeholder="医生可以看到您的电话并联系你" type="number"
          data-parsley-required="true" data-parsley-pattern="/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/" data-parsley-type="integer" data-parsley-length="[11,11]" value="">
      </div>
    </div>

    <div class="weui-cell weui-cell-vcode">
        <div class="weui-cell__hd">
            <label class="weui-label">您的位置</label>
        </div>
        <div class="weui-cell__bd">
          <textarea class="weui-textarea" name="reservation[location]" data-parsley-required="true" placeholder="获取你的位置以便最近的医生联系你"></textarea>
        </div>
        <div class="weui-cell__ft">
            <a href="javascript:void(0)" class="weui-vcode-btn">定位</a>
        </div>
    </div>

    <div class="weui-cell weui-cell-remark">
      <div class="weui-cell__hd">
        <label class="weui-label">症状</label>
      </div>
      <div class="weui-cell__bd weui-cell_primary">
        <textarea class="weui-textarea" name="reservation[chief_complaints]" data-parsley-required="true" placeholder="请大概描述下你孩子的情况"></textarea>
      </div>
    </div>

  </div>

  <!-- <p class="weui-cells__tips">底部说明文字底部说明文字</p> -->

  <div class="weui-btn-area">
    <!-- <a class="weui-btn weui-btn__primary" href="javascript:">确定</a> -->
    <%= f.button :submit, "确定", class: "weui-btn weui-btn__primary", data: { disable_with: '正在提交...' } %>
  </div>

<% end %>


<%- content_for :js  do %>
<script type="text/javascript">
  $(function(){

    wx.config({
      debug: false,
      appId: "<%= @appId %>",
      timestamp: "<%= @timestamp %>",
      nonceStr: "<%= @nonceStr %>",
      signature: "<%= @signature %>",
      jsApiList: ['checkJsApi', 'chooseWXPay', 'chooseImage', 'uploadImage', 'downloadImage', 'previewImage', 'openLocation', 'getLocation'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });

    wx.ready(function(){
      // alert('config is ready, checking js api available');
      wx.checkJsApi({
         jsApiList: [
           'chooseWXPay',
           'previewImage',
           'chooseImage',
           'uploadImage',
           'downloadImage',
           'openLocation',
           'getLocation'
         ],
         success: function (res) {
           console.log(JSON.stringify(res));
         }
       });
    });

    $(document).on('click', '.weui-vcode-btn', function(e){
      console.log('click get Location');
      wx.getLocation({
        type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
        success: function (res) {
          var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
          var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
          var speed = res.speed; // 速度，以米/每秒计
          var accuracy = res.accuracy; // 位置精度

          var data= {
          　　　　　　location: latitude + "," + longitude,
          　　　　　　key: "GHPBZ-BCE3X-GPT4A-7EJHJ-G2TPQ-PTFBQ",
          　　　　　　get_poi:0,
                    output: "jsonp"
          　　　　}

          var url= "http://apis.map.qq.com/ws/geocoder/v1/?";
          console.log('convert latitude and longitude to address');
          $.ajax({
              type: "get",
              dataType:'jsonp',
              data: data,
              jsonp:  "callback",
              jsonpCallback:"QQmap",
              url:url,
              success:function(json){
                  // var toStr = JSON.stringify(json);
                  console.log(json.result.address)
                  if(json.status == 0){
                    $('input[name="reservation[location]"]').val(json.result.address)
                  }
              },
              error : function(err){
                alert("服务端错误，请刷新浏览器后重试")
              }
          })

          // wx.openLocation({
          //   latitude: latitude, // 纬度，浮点数，范围为90 ~ -90
          //   longitude: longitude, // 经度，浮点数，范围为180 ~ -180。
          //   name: '', // 位置名
          //   address: '', // 地址详情说明
          //   scale: 27, // 地图缩放级别,整形值,范围从1~28。默认为最大
          //   infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
          // });

        },
        cancel: function (res) {
            alert('你拒绝了授权获取地理位置');
        }
      });

    })

    wx.error(function(){
      alert('config is error');
    })


    $('.simple_form.new_reservation').parsley({
      uiEnabled: true,
      errorsWrapper: ''
    }).on('field:error', function() {
      $(this.$element).parents('.weui-cell').addClass('validation_error')
    }).on('field:success', function() {
      $(this.$element).parents('.weui-cell').removeClass('validation_error')
    })
  })
</script>
<% end %>
